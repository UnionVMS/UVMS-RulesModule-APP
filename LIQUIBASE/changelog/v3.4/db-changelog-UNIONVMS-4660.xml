<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet id="UNIONVMS-4660-template-for-MovementRules" author="nomikosi">
        <insert tableName="template">
            <column name="template_id" value="2000" />
            <column name="template_name" value="Movement report document" />
            <column name="fact_template" value="MOVEMENT_REPORT_DOCUMENT" />
        </insert>
        <insert tableName="template">
            <column name="template_id" value="2001" />
            <column name="template_name" value="Movement report document id" />
            <column name="fact_template" value="MOVEMENT_REPORT_DOCUMENT_ID" />
        </insert>

        <rollback>
            <delete tableName="template">
                <where>template_id = 2000</where>
            </delete>
            <delete tableName="template">
                <where>template_id = 2001</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="UNIONVMS-4660-update-VP-L00-00-0001" author="nomikosi">
        <insert tableName="rule">
            <column name="template_id" value="2000" />
            <column name="property_names" value="id" />
            <column name="note" value="Check presence. Must be present." />
            <column name="level" value="L00" />
            <column name="error_type" value="ERROR" />
            <column name="disabled" value="false" />
            <column name="br_id" value="VP-L00-00-0001" />
            <column name="rule_id" value="20001"/>
        </insert>
        <insert tableName="context_expression">
            <column name="expression" value="ids == null || ids.isEmpty()"/>
            <column name="failure_message" value="Message creation date/time missing."/>
            <column name="context" value="EU"/>
            <column name="rule_id" value="20001"/>
            <column name="id" value="20001"/>
        </insert>

        <rollback>
            <delete tableName="context_expression">
                <where>rule_id = 20001</where>
            </delete>
            <delete tableName="rule">
                <where>br_id = 'VP-L00-00-0001'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="UNIONVMS-4660-update-VP-L01-00-0002" author="nomikosi">
        <insert tableName="rule">
            <column name="template_id" value="2000" />
            <column name="property_names" value="id" />
            <column name="note" value="Format must be date in UTC according to ISO8601" />
            <column name="level" value="L01" />
            <column name="error_type" value="ERROR" />
            <column name="disabled" value="false" />
            <column name="br_id" value="VP-L01-00-0002" />
            <column name="rule_id" value="20002"/>
        </insert>
        <insert tableName="context_expression">
            <column name="expression" value="ids != null &amp;&amp; !ids.isEmpty() &amp;&amp; !containsTypesOfIdXTimes(ids,&quot;UUID&quot;,1)"/>
            <column name="failure_message" value="Invalid message creation date/time."/>
            <column name="context" value="EU"/>
            <column name="rule_id" value="20002"/>
            <column name="id" value="20002"/>
        </insert>

        <rollback>
            <delete tableName="context_expression">
                <where>rule_id = 20002</where>
            </delete>
            <delete tableName="rule">
                <where>br_id = 'VP-L01-00-0002'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="UNIONVMS-4660-update-VP-L01-00-0003" author="nomikosi">
        <insert  tableName="rule">
            <column name="template_id" value="2001" />
            <column name="property_names" value="id" />
            <column name="note" value="Check Format of the value. Must be according to the specified schemeID." />
            <column name="level" value="L01" />
            <column name="error_type" value="ERROR" />
            <column name="disabled" value="false" />
            <column name="br_id" value="VP-L01-00-0003" />
            <column name="rule_id" value="20003"/>
        </insert >
        <insert  tableName="context_expression">
            <column name="expression" value="id != null &amp;&amp; !uuidValidateRegex(id)"/>
            <column name="failure_message" value="Check Format of the value. Must be according to the specified schemeID."/>
            <column name="context" value="EU"/>
            <column name="rule_id" value="20003"/>
            <column name="id" value="20003"/>
        </insert >

        <rollback>
            <delete tableName="context_expression">
                <where>rule_id = 20003</where>
            </delete>
            <delete tableName="rule">
                <where>br_id = 'VP-L01-00-0003'</where>
            </delete>
        </rollback>
    </changeSet>    
    
    <changeSet id="UNIONVMS-4660-update-VP-L01-00-0006" author="gmanifavas">
        <insert  tableName="rule">
            <column name="template_id" value="2000" />
            <column name="property_names" value="creationDateTime" />
            <column name="note" value="A threshold to compensate for incorrect clock synchronization of the exchanging systems must be taken into account." />
            <column name="level" value="L01" />
            <column name="error_type" value="ERROR" />
            <column name="disabled" value="false" />
            <column name="br_id" value="VP-L01-00-0006" />
            <column name="rule_id" value="20006"/>
        </insert >
        <insert  tableName="context_expression">
            <column name="expression" value="creationDateTimeString != null &amp;&amp; !hasValidCreationDateTime(creationDateTimeString)"/>
            <column name="failure_message" value="Message creation date/time must be a valid UTC date/time in the correct format."/>
            <column name="context" value="EU"/>
            <column name="rule_id" value="20006"/>
            <column name="id" value="20006"/>
        </insert >

        <rollback>
            <delete tableName="context_expression">
                <where>rule_id = 20006</where>
            </delete>
            <delete tableName="rule">
                <where>br_id = 'VP-L01-00-0006'</where>
            </delete>
        </rollback>
    </changeSet>


    <changeSet id="UNIONVMS-4660-update-VP-L03-00-0007" author="nomikosi">
        <insert  tableName="rule">
            <column name="template_id" value="2000" />
            <column name="property_names" value="CreationDateTime" />
            <column name="note" value="A threshold to compensate for incorrect clock synchronization of the exchanging systems must be taken into account." />
            <column name="level" value="L03" />
            <column name="error_type" value="WARNING" />
            <column name="disabled" value="false" />
            <column name="br_id" value="VP-L03-00-0007" />
            <column name="rule_id" value="20007"/>
        </insert >
        <insert  tableName="context_expression">
            <column name="expression" value="creationDateTime != null &amp;&amp; !isDateInThePast(creationDateTime)"/>
            <column name="failure_message" value="Message creation date/time not in the past."/>
            <column name="context" value="EU"/>
            <column name="rule_id" value="20007"/>
            <column name="id" value="20007"/>
        </insert >

        <rollback>
            <delete tableName="context_expression">
                <where>rule_id = 20007</where>
            </delete>
            <delete tableName="rule">
                <where>br_id = 'VP-L03-00-0007'</where>
            </delete>
        </rollback>
    </changeSet>

    <changeSet id="UNIONVMS-4660-update-VP-L00-00-0006" author="gmanifavas">
        <insert  tableName="rule">
            <column name="template_id" value="2000" />
            <column name="property_names" value="purposeCode" />
            <column name="note" value="A threshold to compensate for incorrect clock synchronization of the exchanging systems must be taken into account." />
            <column name="level" value="L00" />
            <column name="error_type" value="ERROR" />
            <column name="disabled" value="false" />
            <column name="br_id" value="VP-L00-00-0006" />
            <column name="rule_id" value="30006"/>
        </insert >
        <insert  tableName="context_expression">
            <column name="expression" value="purposeCode == null || purposeCode.getValue() == null || purposeCode.getValue().trim().isEmpty()"/>
            <column name="failure_message" value="Message PurposeCode missing."/>
            <column name="context" value="EU"/>
            <column name="rule_id" value="30006"/>
            <column name="id" value="30006"/>
        </insert >

        <rollback>
            <delete tableName="context_expression">
                <where>rule_id = 30006</where>
            </delete>
            <delete tableName="rule">
                <where>br_id = 'VP-L00-00-0006'</where>
            </delete>
        </rollback>
    </changeSet>
    
    <changeSet id="UNIONVMS-4660-update-VP-L01-00-0009" author="gmanifavas">
        <insert  tableName="rule">
            <column name="template_id" value="2000" />
            <column name="property_names" value="purposeCode" />
            <column name="note" value="A threshold to compensate for incorrect clock synchronization of the exchanging systems must be taken into account." />
            <column name="level" value="L01" />
            <column name="error_type" value="ERROR" />
            <column name="disabled" value="false" />
            <column name="br_id" value="VP-L01-00-0009" />
            <column name="rule_id" value="20009"/>
        </insert >
        <insert  tableName="context_expression">
            <column name="expression" value="purposeCode != null &amp;&amp; !hasValidPurposeCodeListId(purposeCode, &quot;FLUX_GP_PURPOSE&quot;)"/>
            <column name="failure_message" value="PurposeCode has an invalid listID."/>
            <column name="context" value="EU"/>
            <column name="rule_id" value="20009"/>
            <column name="id" value="20009"/>
        </insert >

        <rollback>
            <delete tableName="context_expression">
                <where>rule_id = 20009</where>
            </delete>
            <delete tableName="rule">
                <where>br_id = 'VP-L01-00-0009'</where>
            </delete>
        </rollback>
    </changeSet>  
    
    <changeSet id="UNIONVMS-4660-update-VP-L01-00-0010" author="gmanifavas">
        <insert  tableName="rule">
            <column name="template_id" value="2000" />
            <column name="property_names" value="purposeCode" />
            <column name="note" value="A threshold to compensate for incorrect clock synchronization of the exchanging systems must be taken into account." />
            <column name="level" value="L01" />
            <column name="error_type" value="ERROR" />
            <column name="disabled" value="false" />
            <column name="br_id" value="VP-L01-00-0010" />
            <column name="rule_id" value="20010"/>
        </insert >
        <insert  tableName="context_expression">
            <column name="expression" value="purposeCode != null &amp;&amp; purposeCode.getValue() != null &amp;&amp; !purposeCode.getValue().trim().isEmpty() &amp;&amp; !hasValidPurposeCodeValue(purposeCode, &quot;9&quot;)"/>
            <column name="failure_message" value="PurposeCode has an invalid value."/>
            <column name="context" value="EU"/>
            <column name="rule_id" value="20010"/>
            <column name="id" value="20010"/>
        </insert >

        <rollback>
            <delete tableName="context_expression">
                <where>rule_id = 20010</where>
            </delete>
            <delete tableName="rule">
                <where>br_id = 'VP-L01-00-0010'</where>
            </delete>
        </rollback>
    </changeSet> 
    
    <changeSet id="UNIONVMS-4660-update-VP-L00-00-0020" author="gmanifavas">
        <insert  tableName="rule">
            <column name="template_id" value="2000" />
            <column name="property_names" value="OwnerFLUXParty" />
            <column name="note" value="A threshold to compensate for incorrect clock synchronization of the exchanging systems must be taken into account." />
            <column name="level" value="L00" />
            <column name="error_type" value="ERROR" />
            <column name="disabled" value="false" />
            <column name="br_id" value="VP-L00-00-0020" />
            <column name="rule_id" value="30020"/>
        </insert >
        <insert  tableName="context_expression">
            <column name="expression" value="ownerFLUXParty == null || (ownerFLUXParty.getIDS() != null &amp;&amp; ownerFLUXParty.getIDS().isEmpty())"/>
            <column name="failure_message" value="Message Owner ID missing."/>
            <column name="context" value="EU"/>
            <column name="rule_id" value="30020"/>
            <column name="id" value="30020"/>
        </insert >

        <rollback>
            <delete tableName="context_expression">
                <where>rule_id = 30020</where>
            </delete>
            <delete tableName="rule">
                <where>br_id = 'VP-L00-00-0020'</where>
            </delete>
        </rollback>
    </changeSet>
</databaseChangeLog>
